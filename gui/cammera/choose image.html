<html lang="en" class="js">

<head>
    <meta charset="utf-8">
    <title>Drag and Drop File Uploading</title>
    <script src="https://kit.fontawesome.com/021a8707ba.js"></script>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://storage.cloud.google.com/idetect-252605.appspot.com/main.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body>
    <div role="main">
        <div id="camera" class="modal fade" style="visibility:hidden">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- Camera sensor -->
                    <canvas id="camera--sensor"></canvas>
                    <!-- Camera view -->
                    <video id="camera--view" autoplay playsinline></video>
                    <!-- Camera output -->
                    <img src="//:0" alt="" id="camera--output" style="visibility:hidden;">
                    <!-- Camera trigger -->
                    <button id="camera--trigger">Take a picture</button>
                    <button id="camera--cencel">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container" role="main" id="drop_zone">
        <div id='loading' hidden=true>
            <div class="load">
                <div class="gear one">
                    <svg id="blue" viewBox="0 0 100 100" fill="#94DDFF">
                        <path
                            d="M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z">
                        </path>
                    </svg>
                </div>
                <div class="gear two">
                    <svg id="pink" viewBox="0 0 100 100" fill="#FB8BB9">
                        <path
                            d="M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z">
                        </path>
                    </svg>
                </div>
                <div class="gear three">
                    <svg id="yellow" viewBox="0 0 100 100" fill="#FFCD5C">
                        <path
                            d="M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z">
                        </path>
                    </svg>
                </div>
                <div class="lil-circle"></div>
                <svg class="blur-circle">
                    <filter id="blur">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="13"></feGaussianBlur>
                    </filter>
                    <circle cx="70" cy="70" r="66" fill="transparent" stroke="white" stroke-width="40"
                        filter="url(#blur)"></circle>
                </svg>
            </div>
            <div class='text'>loading</div>
        </div>

        <form id="formDrop" enctype="multipart/form-data" novalidate="" class="box has-advanced-upload">
            <div id="box__input" class="box__input">
                <svg id="upload_icon" class="box__icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43"
                    viewBox="0 0 50 43">
                    <path
                        d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z">
                    </path>
                </svg>
                <input accept="image/*" type="file" name="files[]" id="file" class="box__file"
                    data-multiple-caption="{count} files selected" multiple="">
                <div id="choose_file">
                    <label for="file"><strong>Choose a file</strong><span class="box__dragndrop"> or drag it
                            here</span>.</label>
                </div>

            </div>
            <div class="box__uploading">Uploadingâ€¦</div>
            <div class="box__success">Done! <a class="box__restart" role="button">Upload more?</a></div>
            <div class="box__error">Error! <span></span>. <a class="box__restart" role="button">Try again!</a></div>
            <input type="hidden" name="ajax" value="1">
        </form>
        <div class="buttons">
            <button title="open camera" id="ToTakePicture">
                <p><i class="fas fa-camera"></i></p>
            </button>

        </div>
        <!-- <div class="buttons">
            <button title="upload" type="submit" id="Upload">
                <p><i class="fas fa-file-upload"></i></p>
            </button>
        </div> -->

        <!-- <button  id="ToTakePicture" ></button>
        <button id="Upload" >Upload</button> -->

        <!-- Reference to your JavaScript file -->
        <script>
            var box__input = document.getElementById("box__input");
            var upload_icon = document.getElementById("upload_icon");
            var choose_file = document.getElementById("choose_file");
            var formDragDrop = document.getElementById("formDrop");
            var imageToSend = "";
            var droppedFiles = false;
            function handleFileSelect(evt) {
                var files = evt.target.files; // FileList object

                // Loop through the FileList and render image files as thumbnails.
                for (var i = 0, f; f = files[i]; i++) {

                    // Only process image files.
                    if (!f.type.match('image.*')) {
                        continue;
                    }

                    var reader = new FileReader();

                    // Closure to capture the file information.
                    reader.onload = (function (theFile) {
                        return function (e) {
                            // Render thumbnail.
                            imageToSend = e.target.result;
                            formDragDrop.style = "background-image:url(" + imageToSend + ")";
                            try {
                                box__input.removeChild(upload_icon);
                            }
                            catch{ }
                            box__input.style = "text-align:center";
                            choose_file.style = "position: absolute;bottom:10px;margin:auto;left: 11%;"
                            var span = document.createElement('span');
                            span.innerHTML = ['<img class="thumb" src="', e.target.result,
                                '" title="', escape(theFile.name), '"/>'].join('');
                            uploadImage(imageToSend);
                        };
                    })(f);

                    // Read in the image file as a data URL.
                    if (files[0].type.match('image.*'))
                        reader.readAsDataURL(f);
                }
            }

            document.getElementById('file').addEventListener('change', handleFileSelect, false);

            function handleFileSelectD(evt) {

                evt.stopPropagation();
                evt.preventDefault();

                var files = evt.dataTransfer.files; // FileList object.
                for (var i = 0, f; f = files[i]; i++) {

                    // Only process image files.
                    if (!f.type.match('image.*')) {
                        continue;
                    }

                    var reader = new FileReader();

                    // Closure to capture the file information.
                    reader.onload = (function (theFile) {
                        return function (e) {
                            // Render thumbnail.
                            imageToSend = e.target.result;
                            formDragDrop.style = "background-image:url(" + imageToSend + ")";
                            try {
                                box__input.removeChild(upload_icon);
                            }
                            catch{ }
                            box__input.style = "text-align:center";
                            choose_file.style = "position: absolute;bottom:10px;margin:autoleft: 11%;"
                            var span = document.createElement('span');
                            span.innerHTML = ['<img class="thumb" src="', e.target.result,
                                '" title="', escape(theFile.name), '"/>'].join('');
                            uploadImage(imageToSend);
                        };
                    })(f);
                    var formDrop = document.getElementById("formDrop");
                    var count = (formDrop.className.match(/box is-dragover/g) || []).length;
                    while (count > 0) {

                        formDrop.className = formDrop.className.replace("box is-dragover", " ");
                        count = (formDrop.className.match(/box is-dragover/g) || []).length;
                    }
                    // Read in the image file as a data URL.
                    reader.readAsDataURL(f);
                }
            }



            function handleDragOver(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                var formDrop = document.getElementById("formDrop");
                //dropZone.cFlassList.add('is-dragover');
                formDrop.className += " " + "box is-dragover";

                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.

            }
            function handleDragLeave(evt) {
                var formDrop = document.getElementById("formDrop");
                //dropZone.classList.add('is-dragover');

                formDrop.className = formDrop.className.replace("/\box is-dragover/g", " ");
                var count = (formDrop.className.match(/box is-dragover/g) || []).length;
                while (count > 0) {

                    formDrop.className = formDrop.className.replace("box is-dragover", " ");
                    count = (formDrop.className.match(/box is-dragover/g) || []).length;
                }
            }
            // Setup the dnd listeners.

            function handleDragEnter(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                var formDrop = document.getElementById("formDrop");
                //dropZone.classList.add('is-dragover');
                formDrop.className += " " + "box is-dragover";

                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            }

            var dropZone = document.getElementById('drop_zone');
            dropZone.addEventListener('dragover', handleDragOver, false);
            dropZone.addEventListener('dragleave', handleDragLeave, false);
            dropZone.addEventListener("dragenter", handleDragEnter, false);
            dropZone.addEventListener('drop', handleFileSelectD, false);

            var constraints = { video: { facingMode: "user" }, audio: false };
            // Define constants
            const cameraView = document.querySelector("#camera--view"),
                cameraOutput = document.querySelector("#camera--output"),
                cameraSensor = document.querySelector("#camera--sensor"),
                cameraTrigger = document.querySelector("#camera--trigger");
            var cameraCencel = document.getElementById('camera--cencel');
            var ToTakePicture = document.getElementById('ToTakePicture');
            cameraCencel.addEventListener('click', cameraCencel, false);
            ToTakePicture.addEventListener('click', cameraStart, false);
            var localStream;
            cameraCencel.onclick = function () {

                var cameraV = document.getElementById("camera");
                localStream.stop();

                cameraV.style.visibility = "hidden";
                var cameraOutput = document.getElementById("camera--output");
                cameraOutput.style.visibility = "hidden";

            }

            function visibleC() {
                var cameraV = document.getElementById("camera");
                cameraV.style.visibility = "visible"
                cameraV.style.position = "absolute";
                cameraV.style.zIndex = "2";
                cameraOutput.style.position = "absolute";
                // cameraTriggerstyle.position = "absolute";
                cameraSensor.style.position = "absolute";
            }

            // Access the device camera and stream to cameraView
            function cameraStart() {
                var flagCamera = true;
                navigator.mediaDevices
                    .getUserMedia(constraints)
                    .then(function (stream) {
                        track = stream.getTracks()[0];
                        cameraView.srcObject = stream;
                        localStream = track;
                    })
                    .catch(function (error) {
                        flagCamera = false;
                        console.error("Oops. Something is broken.", error);
                    }).then(function () {
                        if (flagCamera)
                            visibleC();
                    });
            }
            // Take a picture when cameraTrigger is tapped
            cameraTrigger.onclick = function () {
                cameraSensor.width = cameraView.videoWidth;
                cameraSensor.height = cameraView.videoHeight;
                cameraSensor.getContext("2d").drawImage(cameraView, 0, 0);
                cameraOutput.src = cameraSensor.toDataURL("image/gif");//webp
                imageToSend = cameraOutput.src;
                cameraOutput.style.visibility = "visible";
                cameraOutput.classList.add("taken");
                formDragDrop.style = "background-image:url(" + imageToSend + ")";
                uploadImage(imageToSend);
            };
            function setToBase64(image) {
                ind = image.indexOf("base64,")
                if (ind != -1) {
                    ind += 7;
                    image = image.substring(ind);
                }
                return image;
            }
            // var UploadButton = document.getElementById('Upload');
            function uploadImage(imageToSend) {
                if (imageToSend == "") {
                    alert("please choose image");
                    return;
                }
                imageToSend = setToBase64(imageToSend);
                document.getElementById('loading').hidden = false;
                document.getElementById('formDrop').hidden = true;
                window.parent.postMessage({
                    'image': imageToSend
                }, "*");
            }

            //listening to messege from embeddable when success to send image to server
            if (window.addEventListener) {
                window.addEventListener("message", onMessage, false);
            }
            else if (window.attachEvent) {
                window.attachEvent("onmessage", onMessage, false);
            }
            function onMessage(event) {
                document.getElementById('loading').hidden = true;
                document.getElementById('formDrop').hidden = false;
            }
        </script>
</body>

</html>